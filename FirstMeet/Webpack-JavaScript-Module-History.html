<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript 模块化的发展进程 | XIAOKEDADA</title>
    <meta name="description" content="Write something useful and funny">
    <link rel="icon" href="/xiaokedada/favicon.png">
    
    <link rel="preload" href="/xiaokedada/assets/css/118.styles.306d23a5.css" as="style"><link rel="preload" href="/xiaokedada/assets/js/app.51d0a681.js" as="script"><link rel="preload" href="/xiaokedada/assets/js/75.b692daea.js" as="script"><link rel="prefetch" href="/xiaokedada/assets/js/0.1bd12f53.js"><link rel="prefetch" href="/xiaokedada/assets/js/1.cd946af2.js"><link rel="prefetch" href="/xiaokedada/assets/js/2.ca24feb6.js"><link rel="prefetch" href="/xiaokedada/assets/js/3.5dbaa314.js"><link rel="prefetch" href="/xiaokedada/assets/js/4.65842a86.js"><link rel="prefetch" href="/xiaokedada/assets/js/5.2706d991.js"><link rel="prefetch" href="/xiaokedada/assets/js/6.a9fa93eb.js"><link rel="prefetch" href="/xiaokedada/assets/js/7.07a04857.js"><link rel="prefetch" href="/xiaokedada/assets/js/8.2e73814c.js"><link rel="prefetch" href="/xiaokedada/assets/js/9.9a4ab9ea.js"><link rel="prefetch" href="/xiaokedada/assets/js/10.1579390c.js"><link rel="prefetch" href="/xiaokedada/assets/js/11.86a2e0ac.js"><link rel="prefetch" href="/xiaokedada/assets/js/12.86d07ec2.js"><link rel="prefetch" href="/xiaokedada/assets/js/13.51025cd6.js"><link rel="prefetch" href="/xiaokedada/assets/js/14.723e0304.js"><link rel="prefetch" href="/xiaokedada/assets/js/15.e05c4533.js"><link rel="prefetch" href="/xiaokedada/assets/js/16.4c1175d0.js"><link rel="prefetch" href="/xiaokedada/assets/js/17.6ea7b9a7.js"><link rel="prefetch" href="/xiaokedada/assets/js/18.743491d2.js"><link rel="prefetch" href="/xiaokedada/assets/js/19.c009a8b2.js"><link rel="prefetch" href="/xiaokedada/assets/js/20.4676c2fd.js"><link rel="prefetch" href="/xiaokedada/assets/js/21.ba3174cf.js"><link rel="prefetch" href="/xiaokedada/assets/js/22.68278222.js"><link rel="prefetch" href="/xiaokedada/assets/js/23.c34c06a8.js"><link rel="prefetch" href="/xiaokedada/assets/js/24.d735d321.js"><link rel="prefetch" href="/xiaokedada/assets/js/25.640616f1.js"><link rel="prefetch" href="/xiaokedada/assets/js/26.7712c941.js"><link rel="prefetch" href="/xiaokedada/assets/js/27.183b317a.js"><link rel="prefetch" href="/xiaokedada/assets/js/28.72e53d68.js"><link rel="prefetch" href="/xiaokedada/assets/js/29.906421b2.js"><link rel="prefetch" href="/xiaokedada/assets/js/30.6e4aa06d.js"><link rel="prefetch" href="/xiaokedada/assets/js/31.b1150a91.js"><link rel="prefetch" href="/xiaokedada/assets/js/32.4a8d2fb5.js"><link rel="prefetch" href="/xiaokedada/assets/js/33.697a833c.js"><link rel="prefetch" href="/xiaokedada/assets/js/34.c414b291.js"><link rel="prefetch" href="/xiaokedada/assets/js/35.e321123d.js"><link rel="prefetch" href="/xiaokedada/assets/js/36.07df1a33.js"><link rel="prefetch" href="/xiaokedada/assets/js/37.c2092f91.js"><link rel="prefetch" href="/xiaokedada/assets/js/38.e999f6e6.js"><link rel="prefetch" href="/xiaokedada/assets/js/39.4ad0eec3.js"><link rel="prefetch" href="/xiaokedada/assets/js/40.15c13f22.js"><link rel="prefetch" href="/xiaokedada/assets/js/41.12d9540b.js"><link rel="prefetch" href="/xiaokedada/assets/js/42.048a5c79.js"><link rel="prefetch" href="/xiaokedada/assets/js/43.23a0cac2.js"><link rel="prefetch" href="/xiaokedada/assets/js/44.e552c633.js"><link rel="prefetch" href="/xiaokedada/assets/js/45.347f0a95.js"><link rel="prefetch" href="/xiaokedada/assets/js/46.59bb9a80.js"><link rel="prefetch" href="/xiaokedada/assets/js/47.0a72aee1.js"><link rel="prefetch" href="/xiaokedada/assets/js/48.32c141f4.js"><link rel="prefetch" href="/xiaokedada/assets/js/49.3610d444.js"><link rel="prefetch" href="/xiaokedada/assets/js/50.350e5049.js"><link rel="prefetch" href="/xiaokedada/assets/js/51.d01155cb.js"><link rel="prefetch" href="/xiaokedada/assets/js/52.a5015ced.js"><link rel="prefetch" href="/xiaokedada/assets/js/53.7b73d8b1.js"><link rel="prefetch" href="/xiaokedada/assets/js/54.092ee587.js"><link rel="prefetch" href="/xiaokedada/assets/js/55.9a2f189a.js"><link rel="prefetch" href="/xiaokedada/assets/js/56.27e46b17.js"><link rel="prefetch" href="/xiaokedada/assets/js/57.d080c747.js"><link rel="prefetch" href="/xiaokedada/assets/js/58.2364eb76.js"><link rel="prefetch" href="/xiaokedada/assets/js/59.9deb8139.js"><link rel="prefetch" href="/xiaokedada/assets/js/60.387795af.js"><link rel="prefetch" href="/xiaokedada/assets/js/61.3d0b8582.js"><link rel="prefetch" href="/xiaokedada/assets/js/62.f5702f6b.js"><link rel="prefetch" href="/xiaokedada/assets/js/63.6e8cc274.js"><link rel="prefetch" href="/xiaokedada/assets/js/64.59692959.js"><link rel="prefetch" href="/xiaokedada/assets/js/65.642d2089.js"><link rel="prefetch" href="/xiaokedada/assets/js/66.515778c0.js"><link rel="prefetch" href="/xiaokedada/assets/js/67.09fd142a.js"><link rel="prefetch" href="/xiaokedada/assets/js/68.d2fd2b20.js"><link rel="prefetch" href="/xiaokedada/assets/js/69.54b34dff.js"><link rel="prefetch" href="/xiaokedada/assets/js/70.08cfd9f1.js"><link rel="prefetch" href="/xiaokedada/assets/js/71.8af3cac6.js"><link rel="prefetch" href="/xiaokedada/assets/js/72.8cf1ac97.js"><link rel="prefetch" href="/xiaokedada/assets/js/73.0d2c3de9.js"><link rel="prefetch" href="/xiaokedada/assets/js/74.c5383443.js"><link rel="prefetch" href="/xiaokedada/assets/js/76.f1760c70.js"><link rel="prefetch" href="/xiaokedada/assets/js/77.024d7794.js"><link rel="prefetch" href="/xiaokedada/assets/js/78.54101d27.js"><link rel="prefetch" href="/xiaokedada/assets/js/79.395e6dea.js"><link rel="prefetch" href="/xiaokedada/assets/js/80.3e659e88.js"><link rel="prefetch" href="/xiaokedada/assets/js/81.31d7c9c5.js"><link rel="prefetch" href="/xiaokedada/assets/js/82.76901e43.js"><link rel="prefetch" href="/xiaokedada/assets/js/83.86b6f686.js"><link rel="prefetch" href="/xiaokedada/assets/js/84.e08c1f31.js"><link rel="prefetch" href="/xiaokedada/assets/js/85.a28700bf.js"><link rel="prefetch" href="/xiaokedada/assets/js/86.57747352.js"><link rel="prefetch" href="/xiaokedada/assets/js/87.6495c6ae.js"><link rel="prefetch" href="/xiaokedada/assets/js/88.fe6c9a90.js"><link rel="prefetch" href="/xiaokedada/assets/js/89.48f45856.js"><link rel="prefetch" href="/xiaokedada/assets/js/90.c2c96eb9.js"><link rel="prefetch" href="/xiaokedada/assets/js/91.466b65d5.js"><link rel="prefetch" href="/xiaokedada/assets/js/92.2c835547.js"><link rel="prefetch" href="/xiaokedada/assets/js/93.d0f32c26.js"><link rel="prefetch" href="/xiaokedada/assets/js/94.6d7ef6f7.js"><link rel="prefetch" href="/xiaokedada/assets/js/95.efa056b8.js"><link rel="prefetch" href="/xiaokedada/assets/js/96.1a9f1737.js"><link rel="prefetch" href="/xiaokedada/assets/js/97.68765c16.js"><link rel="prefetch" href="/xiaokedada/assets/js/98.c65e6193.js"><link rel="prefetch" href="/xiaokedada/assets/js/99.734ab7e3.js"><link rel="prefetch" href="/xiaokedada/assets/js/100.ffb81130.js"><link rel="prefetch" href="/xiaokedada/assets/js/101.52409c86.js"><link rel="prefetch" href="/xiaokedada/assets/js/102.2b0d4b0d.js"><link rel="prefetch" href="/xiaokedada/assets/js/103.ecdf3ea3.js"><link rel="prefetch" href="/xiaokedada/assets/js/104.d991dc2b.js"><link rel="prefetch" href="/xiaokedada/assets/js/105.6a089ee7.js"><link rel="prefetch" href="/xiaokedada/assets/js/106.826b0deb.js"><link rel="prefetch" href="/xiaokedada/assets/js/107.6306b794.js"><link rel="prefetch" href="/xiaokedada/assets/js/108.dc62e716.js"><link rel="prefetch" href="/xiaokedada/assets/js/109.18b18713.js"><link rel="prefetch" href="/xiaokedada/assets/js/110.b5de4946.js"><link rel="prefetch" href="/xiaokedada/assets/js/111.fea6ceb6.js"><link rel="prefetch" href="/xiaokedada/assets/js/112.c1b52e48.js"><link rel="prefetch" href="/xiaokedada/assets/js/113.660b807b.js"><link rel="prefetch" href="/xiaokedada/assets/js/114.37c0dee4.js"><link rel="prefetch" href="/xiaokedada/assets/js/115.22f7ee1d.js"><link rel="prefetch" href="/xiaokedada/assets/js/116.8b3a33cc.js"><link rel="prefetch" href="/xiaokedada/assets/js/117.8f39d356.js">
    <link rel="stylesheet" href="/xiaokedada/assets/css/118.styles.306d23a5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/xiaokedada/" class="home-link router-link-active"><!----><span class="site-name">
      XIAOKEDADA
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/xiaokedada/Blog/" class="nav-link">Blog</a></div><div class="nav-item"><a href="/xiaokedada/JavaScript/" class="nav-link">JavaScript</a></div><div class="nav-item"><a href="/xiaokedada/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/xiaokedada/FirstMeet/" class="nav-link router-link-active">More</a></div><div class="nav-item"><a href="/xiaokedada/CSS/" class="nav-link">CSS</a></div><div class="nav-item"><a href="/xiaokedada/ReadingNote/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/xiaokedada/Weekly/" class="nav-link">Weekly</a></div><div class="nav-item"><a href="/xiaokedada/GatherAll/" class="nav-link">R &amp; T</a></div><a href="https://github.com/maoxiaoke/xiaokedada" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/xiaokedada/Blog/" class="nav-link">Blog</a></div><div class="nav-item"><a href="/xiaokedada/JavaScript/" class="nav-link">JavaScript</a></div><div class="nav-item"><a href="/xiaokedada/React/" class="nav-link">React</a></div><div class="nav-item"><a href="/xiaokedada/FirstMeet/" class="nav-link router-link-active">More</a></div><div class="nav-item"><a href="/xiaokedada/CSS/" class="nav-link">CSS</a></div><div class="nav-item"><a href="/xiaokedada/ReadingNote/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/xiaokedada/Weekly/" class="nav-link">Weekly</a></div><div class="nav-item"><a href="/xiaokedada/GatherAll/" class="nav-link">R &amp; T</a></div><a href="https://github.com/maoxiaoke/xiaokedada" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>First-Meet Series</span><!----></p><ul class="sidebar-group-items"><li><a href="/xiaokedada/FirstMeet/First-Meet-JSON.html" class="sidebar-link">JSON 必知必会</a></li><li><a href="/xiaokedada/FirstMeet/First-Meet-Cache.html" class="sidebar-link">Web缓存知多少(缓存机制和数据存储)</a></li><li><a href="/xiaokedada/FirstMeet/First-Meet-Flux.html" class="sidebar-link">Flux 学习</a></li><li><a href="/xiaokedada/FirstMeet/First-Meet-TypeScript.html" class="sidebar-link">TypeScript 通识</a></li><li><a href="/xiaokedada/FirstMeet/First-Meet-Webpack.html" class="sidebar-link">新学 Webpack</a></li><li><a href="/xiaokedada/FirstMeet/First-Meet-JavaScript.html" class="sidebar-link">JavaScript 一些奇怪的地方</a></li><li><a href="/xiaokedada/FirstMeet/First-Meet-NestJS.html" class="sidebar-link">NestJS 之道</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>All About Vue</span><!----></p><ul class="sidebar-group-items"><li><a href="/xiaokedada/FirstMeet/First-Meet-Vue-Communication.html" class="sidebar-link">解锁 vue2.0 通信的各种姿势</a></li><li><a href="/xiaokedada/FirstMeet/How-To-Write-Vue.html" class="sidebar-link">开发中遇到的 vue 的使用记录一下</a></li><li><a href="/xiaokedada/FirstMeet/Vuex-And-V-Model.html" class="sidebar-link">vuex 和 v-model</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>关于我自己学习的 Webpack</span><!----></p><ul class="sidebar-group-items"><li><a href="/xiaokedada/FirstMeet/Webpack-With-Tool.html" class="sidebar-link">Webpack 可视化工具</a></li><li><a href="/xiaokedada/FirstMeet/Webpack-Operating-Principle.html" class="sidebar-link">从打包结果看 webpack 依赖管理</a></li><li><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html" class="active sidebar-link">JavaScript 模块化的发展进程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#模块化编程" class="sidebar-link">模块化编程</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#iife" class="sidebar-link">IIFE</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#iife-和-闭包" class="sidebar-link">IIFE 和 闭包</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#处理模块依赖" class="sidebar-link">处理模块依赖</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#槽点" class="sidebar-link">槽点</a></li></ul></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#commonjs-modules-2009" class="sidebar-link">CommonJS Modules (2009)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#commonjs-的兴起" class="sidebar-link">CommonJS 的兴起</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#设计-module-format" class="sidebar-link">设计 Module Format</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#commonjs-modules-1-1-format" class="sidebar-link">CommonJS Modules/1.1 Format</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#在-node-js-的实现" class="sidebar-link">在 Node.js 的实现</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#commonjs-module-的浏览器实现" class="sidebar-link">CommonJS Module 的浏览器实现</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#缺陷" class="sidebar-link">缺陷</a></li></ul></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#appendix" class="sidebar-link">Appendix</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#format-和-loader" class="sidebar-link">Format 和 Loader</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#modularity-is-expensive" class="sidebar-link">Modularity is expensive</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#node-js-support-es-module" class="sidebar-link">Node.js support ES Module</a></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#browserify-支持-umd-打包" class="sidebar-link">browserify 支持 umd 打包</a></li></ul></li><li class="sidebar-sub-header"><a href="/xiaokedada/FirstMeet/Webpack-JavaScript-Module-History.html#reference" class="sidebar-link">Reference</a></li></ul></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Type System</span><!----></p><ul class="sidebar-group-items"><li><a href="/xiaokedada/FirstMeet/Type-System-ML.html" class="sidebar-link">数理逻辑理论</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="javascript-模块化的发展进程"><a href="#javascript-模块化的发展进程" aria-hidden="true" class="header-anchor">#</a> JavaScript 模块化的发展进程</h1><p>JavaScript 是一门缺陷语言。不过可喜的是，有些缺点处于改进当中，有些还在将错就错。</p><p>幸运的是，JavaScript 模块化的发展似乎都在处于一个进步的过程；为了支持 JavaScript 的模块化编程，ECMA 提出了 ES6 Module 方案。</p><p>Notes:</p><ol><li>了解什么是模块化编程、价值和方式</li><li>介绍 JavaScript 模块化的发展，产生原因、Pros and Cons</li><li>AMD、CMD、CommonJS 的实现</li></ol><h2 id="模块化编程"><a href="#模块化编程" aria-hidden="true" class="header-anchor">#</a> 模块化编程</h2><p>广义上来说，模块化思想是一种结构化思维。在 <a href="/xiaokedada/JavaScript/Light-FP-01-Overview.html">编程的本质</a> 其实提到了这一点：将信息进行结构化的分解并重新复合，是对人类思维缺陷的一种妥协。</p><blockquote><p>大脑不擅长处理无规律的信息</p></blockquote><p>更戏谑的一种说法是，</p><blockquote><p>把所有的代码写到一个文件里会让我疯掉的。</p></blockquote><p>模块化是面对 <em>复杂度</em> 的 <strong>一个</strong> 解决方案。<em>代码复杂度</em> 可以从下面两点评估：</p><ul><li>各部分之间的相互融合</li><li>代码实现复杂、难以理解、难调试、难扩展</li></ul><p>通过模块化编程，可以做到：</p><ol><li>隐藏(hide)难以理解的、逻辑复杂的代码</li><li>关注点分离(separation of concerns)、可复用(reuseful)、好管理(manageable)</li></ol><p>模块化编程是好的，但代价也是昂贵的。在编码的过程中，需要分散精力思考此处是否需要抽出一个模块、如何设计良好的 API (这是非常重要的，设计糟糕的 API 是恶魔)、关注点的界限如何判定等等。</p><p>It's pretty hard!!!</p><p>好吧，接下来换一个角度来思考下一个问题：<strong>模块化是大脑面对复杂度的最佳解决方案吗</strong>。很多场景下，我们理想当然地(被迫 or 主动)采用模块化编程(Take It For Granted)，有没有其他方式来 escape 它吗？结构化是一种理想的思维方式吗？</p><p>I don't konw.</p><h2 id="iife"><a href="#iife" aria-hidden="true" class="header-anchor">#</a> IIFE</h2><p>通过 IIFE 和 闭包，可以对外暴露一个绑定在 window 的对象，进而最小化地减少污染全局作用域 (global namespace)。</p><h3 id="iife-和-闭包"><a href="#iife-和-闭包" aria-hidden="true" class="header-anchor">#</a> IIFE 和 闭包</h3><p>下面的代码是一个基于 IIFE 方式的一个 <code>myMath</code> 模块的设计方式。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>global<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  global<span class="token punctuation">.</span>myMath <span class="token operator">=</span> global<span class="token punctuation">.</span>myMath <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  global<span class="token punctuation">.</span>myMath<span class="token punctuation">.</span>sum <span class="token operator">=</span> sum

  <span class="token keyword">function</span> <span class="token function">sum</span> <span class="token punctuation">(</span><span class="token operator">...</span>values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> values<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span>
</code></pre></div><p>基于这种方式，可以将每个 IIFE 模块隔离在给自 <code>.js</code> 文件中；也可以将多个 IIFE 模块存放在一个 <code>.js</code> 文件中。</p><h3 id="处理模块依赖"><a href="#处理模块依赖" aria-hidden="true" class="header-anchor">#</a> 处理模块依赖</h3><p>但是无论如何，这种方式都需要开发者手动控制模块依赖，以防 <code>undefined</code> 错误。</p><p>比如，另一个 IIFE 函数存放了一个称为 <code>checkType</code> 模块，<code>myMath</code> 模块依赖该模块。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// checkType 模块需要在 myMath 模块之前运行</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>global<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  global<span class="token punctuation">.</span>checkType <span class="token operator">=</span> global<span class="token punctuation">.</span>checkType <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  global<span class="token punctuation">.</span>checkType<span class="token punctuation">.</span>type <span class="token operator">=</span> type

  <span class="token keyword">function</span> <span class="token function">type</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 分号是必须的</span>

<span class="token comment">// myMath module</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>global<span class="token punctuation">,</span> $<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  global<span class="token punctuation">.</span>myMath <span class="token operator">=</span> global<span class="token punctuation">.</span>myMath <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  global<span class="token punctuation">.</span>myMath<span class="token punctuation">.</span>sum <span class="token operator">=</span> sum

  <span class="token keyword">function</span> <span class="token function">sum</span> <span class="token punctuation">(</span><span class="token operator">...</span>values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> areAllNumbers <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>a <span class="token operator">=&gt;</span> $<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'Number'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> areAllNumbers <span class="token operator">?</span> values<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'numbers are required!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> window<span class="token punctuation">.</span>checkType<span class="token punctuation">)</span>
</code></pre></div><p>可以看到，如果模块处于单个 js 文件内，需要手动调整的模块的运行顺序以建立正确的 <em>依赖图</em>(dependency graph) 或 <em>依赖树</em>(dependency tree)；如果模块分割在多个 js 文件中，js 文件需要按照依赖关系加载，如下：</p><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./check-type.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./my-math.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p><a href="http://www.bradoncode.com/blog/2015/08/26/javascript-semi-colon-insertion/" target="_blank" rel="noopener noreferrer">automatic semicolon insertion <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 需要添加到每个 IIFE 函数的末尾。</p></div><h3 id="槽点"><a href="#槽点" aria-hidden="true" class="header-anchor">#</a> 槽点</h3><p>采用 IIFE 的方案的模块化是一个很大的进步，但离一个 <em>好</em> 的模块化方案还很远，主要在于：</p><ul><li>缺乏有效的依赖管理</li><li>最小化地减少污染全局空间，but 还是严重地污染了全局空间，这不可接受</li></ul><p><del> 但是，IIFE 为后续的模块化工作提供了很多的思路。</del></p><h2 id="commonjs-modules-2009"><a href="#commonjs-modules-2009" aria-hidden="true" class="header-anchor">#</a> CommonJS Modules (2009)</h2><h3 id="commonjs-的兴起"><a href="#commonjs-的兴起" aria-hidden="true" class="header-anchor">#</a> CommonJS 的兴起</h3><p>随着 Node.js 的兴起，为了解决规范无法为 Server 端提供一致性的 API 的问题，由<a href="https://github.com/dangoor" target="_blank" rel="noopener noreferrer">Kevin Dangoor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 发起了一个 <a href="https://serverjs.io/" target="_blank" rel="noopener noreferrer">ServerJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 项目。后来更名为 <a href="http://www.commonjs.org/" target="_blank" rel="noopener noreferrer">CommonJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，旨在为服务端、客户端、沙箱环境提供全方位的可互操作的(interoperable) 的 API，包括<sup>1</sup>：</p><ul><li>模块系统</li><li>二进制字符串和缓冲区</li><li>文件系统接口</li><li>Socket 流</li><li>本地和远程的包和包管理</li><li>...</li></ul><p>之后，还发布了和模块系统有关的 <a href="http://wiki.commonjs.org/wiki/Modules/1.1" target="_blank" rel="noopener noreferrer">Modules/1.1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 规范、和系统接口有关的 <a href="http://wiki.commonjs.org/wiki/System/1.0" target="_blank" rel="noopener noreferrer">System/1.0<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 单元测试有关的 <a href="http://wiki.commonjs.org/wiki/Unit_Testing/1.0" target="_blank" rel="noopener noreferrer">Unit Testing/1.0<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 规范。</p><p>对于这段历史，墙裂推荐 <a href="https://arstechnica.com/information-technology/2009/12/commonjs-effort-sets-javascript-on-path-for-world-domination/" target="_blank" rel="noopener noreferrer">CommonJS effort sets JavaScript on path for world domination<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这篇 CommonJS 的推广文章。</p><p>虽然 CommonJS 很有雄心抱负，但由于 Node.js 采用了 CommonJS 的 <a href="http://wiki.commonjs.org/wiki/Modules/1.1" target="_blank" rel="noopener noreferrer">Modules/1.1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 规范，所以使得 CommonJS 的模块系统规范更广为人知。</p><h3 id="设计-module-format"><a href="#设计-module-format" aria-hidden="true" class="header-anchor">#</a> 设计 Module Format</h3><p><del>...</del></p><h3 id="commonjs-modules-1-1-format"><a href="#commonjs-modules-1-1-format" aria-hidden="true" class="header-anchor">#</a> CommonJS Modules/1.1 Format</h3><p><a href="http://wiki.commonjs.org/wiki/Modules/1.1" target="_blank" rel="noopener noreferrer">Modules/1.1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 介绍了 CommonJS Modules/1.1 的 Format，引用如下：</p><ul><li><strong>Module Context</strong></li></ul><ol><li>在模块中，有个函数，函数名为 <code>require</code></li></ol><ul><li><code>require</code> 函数接收一个 <em>module identifier</em>。</li><li><code>require</code> 函数返回 <em>外部模块</em> 导出的 API。</li><li>如果存在循环依赖，...</li><li>如果外部模块无法返回，<code>require</code> 函数抛错</li><li><code>require</code> 函数可能会有一个表示为顶层 <em>模块</em> 对象 <code>main</code> 属性，该属性只读且无法删除；如果该属性已经提供了，则必须和主程序的的 <em>模块</em> 对象完全一致。</li><li><code>require</code> 函数可以有一个 <code>paths</code> 属性。该属性是一个具有优先顺序的 <em>路径字符串</em> 的数组。
<ol><li>....</li><li>...</li></ol></li></ul><ol start="2"><li>在模块中，有一个对象 <code>exports</code>，模块在执行过程中为其添加导出 API</li></ol><ul><li>模块<strong>必须使用</strong><code>exports</code> 对象作为唯一导出方式</li></ul><ol start="3"><li>在模块中，<strong>必须有</strong>一个对象 <code>module</code></li></ol><ul><li><p><code>module</code> 对象必须有一个只读的、不可删除的 <code>id</code> 属性，<code>id</code> 属性值即为顶层模块 <em>id</em>(标记)。</p></li><li><p><code>module</code> 对象可能会有一个 <code>uri</code> 属性。</p></li><li><p><strong>Module Identifiers</strong></p></li></ul><ol><li>模块标识符是由 <code>/</code> 分隔 <em>名称</em> 的字符串</li><li><em>名称</em> 必须是 camelCase 标识符， <code>./</code> 或 <code>../</code></li><li>模块标识符不必有文件类型后缀，比如 <code>.js</code></li><li>模块标识符可以是 <em>相对</em> 或 <em>顶层</em>。如果第一个 <em>名称</em> 是 <code>.</code> 或 <code>..</code>，则这是个 <em>相对模块标识符</em></li><li><em>顶层标识符</em> 是通过 conceptual module name space root 解析</li><li><em>相对标识符</em> 是相对于调用 <code>require</code> 的模块来解析的</li></ol><h3 id="在-node-js-的实现"><a href="#在-node-js-的实现" aria-hidden="true" class="header-anchor">#</a> 在 Node.js 的实现</h3><p>在 <a href="#Appendix">Appendix</a> 强调了一点，CommonJS Modules/1.1 只是 module format，因此它又有很多<a href="https://en.wikipedia.org/wiki/CommonJS" target="_blank" rel="noopener noreferrer">实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>Node.js 中的 <a href="https://github.com/nodejs/node/blob/master/lib/internal/modules/cjs/loader.js" target="_blank" rel="noopener noreferrer">module<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 实现了 CommonJS Modules/1.1 format。具体细节不在此处讨论，主要了解 Node.js 如何处理模块(在 Node.js 模块系统中，每个文件会被处理成单个的模块)并如何通过 <code>require</code> 函数加载。</p><p>通过 <a href="https://code.visualstudio.com/" target="_blank" rel="noopener noreferrer">VSCODE<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 断点调试，初步理清 Node.js 的加载策略。测试代码如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// sum.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>values<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> values<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// index.js</span>
<span class="token keyword">const</span> sum <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./sum'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><ol><li>通过 index.js 模块的 require 函数加载 './sum.js'</li></ol><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Invoke with makeRequireFunction(module) where |module| is the Module object</span>
<span class="token comment">// to use as the context for the require() function.</span>
<span class="token keyword">function</span> <span class="token function">makeRequireFunction</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Module <span class="token operator">=</span> mod<span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      exports<span class="token punctuation">.</span>requireDepth <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> mod<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过 index.js 模块的 require 加载 './sum.js'</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      exports<span class="token punctuation">.</span>requireDepth <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre></div><p>然后深入 <code>mod.require()</code> 函数，这个函数会加载 <code>./sum.js</code> 模块，并返回 <code>./sum.js</code> 模块的 <code>exports</code> 属性。</p><ol start="2"><li>加载模块</li></ol><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Loads a module at the given file path. Returns that module's</span>
<span class="token comment">// `exports` property.</span>
Module<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_INVALID_ARG_TYPE</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'string'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ERR_INVALID_ARG_VALUE</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
                                    <span class="token string">'must be a non-empty string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Module<span class="token punctuation">.</span><span class="token function">_load</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token comment">/* isMain */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>继续深入 <code>Module._load()</code>。</p><ol start="3"><li>处理模块加载</li></ol><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Check the cache for the requested file.</span>
<span class="token comment">// 1. If a module already exists in the cache: return its exports object.</span>
<span class="token comment">// 2. If the module is native: call `NativeModule.require()` with the</span>
<span class="token comment">//    filename and return the result.</span>
<span class="token comment">// 3. Otherwise, create a new module for the file and save it to the cache.</span>
<span class="token comment">//    Then have it load  the file contents before returning its exports</span>
<span class="token comment">//    object.</span>
Module<span class="token punctuation">.</span><span class="token function-variable function">_load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Module._load REQUEST %s parent: %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> parent<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取模块文件名</span>
  <span class="token keyword">var</span> filename <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFilename</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 处理缓存模块</span>
  <span class="token keyword">var</span> cachedModule <span class="token operator">=</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateChildren</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> cachedModule<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cachedModule<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理 native 模块</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>NativeModule<span class="token punctuation">.</span><span class="token function">nonInternalExists</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'load native module %s'</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> NativeModule<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Don't call updateChildren(), Module constructor already does.</span>
  <span class="token comment">// 处理第三方模块</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>mainModule <span class="token operator">=</span> module<span class="token punctuation">;</span>
    module<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">;</span>

  <span class="token comment">// 加载第三方模块</span>
  <span class="token function">tryModuleLoad</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里可以看到 Node.js (1) 如何解析文件路径；(2) 模块的缓存策略；(3) 如何加载 native 模块；(4) 如何加载第三方模块。</p><p>这里我们更关心如何加载第三方模块，因此我们深入到 <code>tryModuleLoad(module, filename);</code> 函数内部，一探究竟。</p><ol start="4"><li>将控制权转交给 ‘./sum.js’ 模块处理加载内容</li></ol><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// loader.js</span>
<span class="token keyword">function</span> <span class="token function">tryModuleLoad</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> threw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    threw <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>threw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span>

<span class="token comment">// loader.js</span>
<span class="token comment">// Given a file name, pass it to the proper extension handler.</span>
Module<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'load %j for module %j'</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>loaded<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> filename<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>paths <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_nodeModulePaths</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> extension <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'.js'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token punctuation">)</span> extension <span class="token operator">=</span> <span class="token string">'.js'</span><span class="token punctuation">;</span>

  <span class="token comment">// 传递给 extension 处理器处理 .js/.json/.node 文件</span>
  Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token comment">// 实验性质的模块额外处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>experimentalModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncESM <span class="token operator">===</span> undefined<span class="token punctuation">)</span> <span class="token function">lazyLoadESM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ESMLoader <span class="token operator">=</span> asyncESM<span class="token punctuation">.</span>ESMLoader<span class="token punctuation">;</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">getURLFromFilePath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> urlString <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> exports <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ESMLoader<span class="token punctuation">.</span>moduleMap<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>urlString<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ESMLoader<span class="token punctuation">.</span>moduleMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>
        urlString<span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">ModuleJob</span><span class="token punctuation">(</span>ESMLoader<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token function">createDynamicModule</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
          ctx<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> job <span class="token operator">=</span> ESMLoader<span class="token punctuation">.</span>moduleMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>urlString<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>job<span class="token punctuation">.</span>reflect<span class="token punctuation">)</span>
        job<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>对于 <code>.js</code> 文件，Node.js 会读取文件内容，并编译内容。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Native extension for .js</span>
Module<span class="token punctuation">.</span>_extensions<span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span><span class="token function">stripBOM</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>接下来就是很有意思的内容，Node.js 是如何处理编译文件内容呢？</p><ol start="5"><li>包裹编译内容</li></ol><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Run the file contents in the correct scope or sandbox. Expose</span>
<span class="token comment">// the correct helper variables (require, module, exports) to</span>
<span class="token comment">// the file.</span>
<span class="token comment">// Returns exception, if any.</span>
Module<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_compile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  content <span class="token operator">=</span> <span class="token function">stripShebang</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// create wrapper function</span>
  <span class="token keyword">var</span> wrapper <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> compiledWrapper <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">runInThisContext</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">:</span> filename<span class="token punctuation">,</span>
    lineOffset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    displayErrors<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> inspectorWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>_breakFirstLine <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>_eval <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolvedArgv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// we enter the repl if we're not given a filename argument.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resolvedArgv <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFilename</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        resolvedArgv <span class="token operator">=</span> <span class="token string">'repl'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Set breakpoint on module start</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filename <span class="token operator">===</span> resolvedArgv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> process<span class="token punctuation">.</span>_breakFirstLine<span class="token punctuation">;</span>
      inspectorWrapper <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">binding</span><span class="token punctuation">(</span><span class="token string">'inspector'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>callAndPauseOnStart<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> require <span class="token operator">=</span> <span class="token function">makeRequireFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> depth <span class="token operator">=</span> requireDepth<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> stat<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> result<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inspectorWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> <span class="token function">inspectorWrapper</span><span class="token punctuation">(</span>compiledWrapper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">,</span>
                              require<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    result <span class="token operator">=</span> compiledWrapper<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                                  filename<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> stat<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这是个模块编译的核心内容，在 <code>var wrapper = Module.wrap(content);</code> 中，文件内容会被函数包裹起来，形成 <em>闭包</em>。</p><div class="language-js extra-class"><pre class="language-js"><code>Module<span class="token punctuation">.</span><span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> script <span class="token operator">+</span> Module<span class="token punctuation">.</span>wrapper<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Module<span class="token punctuation">.</span>wrapper <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'(function (exports, require, module, __filename, __dirname) { '</span><span class="token punctuation">,</span>
  <span class="token string">'\n});'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>也就是说，'./sum.js' 中的代码在编译时(真正执行之前)会被 <code>(function (exports, require, module, __filename, __dirname)</code> 包装。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname<span class="token punctuation">)</span> <span class="token punctuation">{</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>values<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> values<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>就这样，模块就可以避免污染全局命名空间；紧接着通过 <em>sandbox</em> 运行环境运行代码，返回导出的 API。即下面的这几行代码：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
result <span class="token operator">=</span> compiledWrapper<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                              filename<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><p>简而言之，<code>require()</code> 函数内部 <em>类似于</em> 有一个 IIFE 函数立即执行，返回 <code>exports</code>(<a href="https://nodejs.org/docs/latest/api/modules.html#modules_exports_shortcut" target="_blank" rel="noopener noreferrer">官网有个简易版的实例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。</p><p>TODO:</p><ul><li>[ ] 依赖管理</li></ul><h3 id="commonjs-module-的浏览器实现"><a href="#commonjs-module-的浏览器实现" aria-hidden="true" class="header-anchor">#</a> CommonJS Module 的浏览器实现</h3><p><a href="http://browserify.org/" target="_blank" rel="noopener noreferrer">browserify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是实现 CommonJS Module Format 的一个浏览器的模块打包器(不仅仅是一个 format loader)。它会将所有的模块聚合成一个大的 IIFE 函数，使其能够在浏览器中运行。为使一个 Loader 支持浏览器，实现 loader 的库应当考虑如何 <strong>打包</strong> 各个模块(打包器)。</p><p>测试用例如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ./index.js</span>
<span class="token keyword">const</span> <span class="token constant">R</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./sum'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> exports <span class="token operator">=</span> <span class="token constant">R</span>

<span class="token comment">// ./sum.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>values<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> values<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p>打包出来的结果如下：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">function</span> <span class="token function">r</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span>n<span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">function</span> <span class="token function">o</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> c<span class="token operator">=</span><span class="token string">&quot;function&quot;</span><span class="token operator">==</span><span class="token keyword">typeof</span> require<span class="token operator">&amp;&amp;</span>require<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token operator">&amp;&amp;</span>c<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token function">c</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token function">u</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token operator">!</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> a<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot find module '&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">throw</span> a<span class="token punctuation">.</span>code<span class="token operator">=</span><span class="token string">&quot;MODULE_NOT_FOUND&quot;</span><span class="token punctuation">,</span>a<span class="token punctuation">}</span><span class="token keyword">var</span> p<span class="token operator">=</span>n<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span>exports<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>exports<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> n<span class="token operator">=</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">o</span><span class="token punctuation">(</span>n<span class="token operator">||</span>r<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span>p<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>r<span class="token punctuation">,</span>e<span class="token punctuation">,</span>n<span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">return</span> n<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">}</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> u<span class="token operator">=</span><span class="token string">&quot;function&quot;</span><span class="token operator">==</span><span class="token keyword">typeof</span> require<span class="token operator">&amp;&amp;</span>require<span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>t<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token function">o</span><span class="token punctuation">(</span>t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> o<span class="token punctuation">}</span><span class="token keyword">return</span> r<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>require<span class="token punctuation">,</span>module<span class="token punctuation">,</span>exports<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token keyword">const</span> <span class="token constant">R</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./sum'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> exports <span class="token operator">=</span> <span class="token constant">R</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">&quot;./sum&quot;</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token keyword">function</span><span class="token punctuation">(</span>require<span class="token punctuation">,</span>module<span class="token punctuation">,</span>exports<span class="token punctuation">)</span><span class="token punctuation">{</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>values<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> values<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>初看下来，实际上 browserify 的 <em>打包</em> 和 <em>依赖管理</em> 于 <a href="/xiaokedada/FirstMeet/Webpack-Operating-Principle.html">webpack</a> 很相似。</p><h3 id="缺陷"><a href="#缺陷" aria-hidden="true" class="header-anchor">#</a> 缺陷</h3><p>从 Node.js 的实现上分析，CommonJS Module 较好地解决了依赖管理和命名空间的问题，是一次巨大的进步。但它还缺乏：</p><ol><li>异步加载模块的机制。</li></ol><p>从代码上看，<code>require()</code> 是一个典型的同步操作。这是合理的，作为服务端运行环境，模块要么加载成功，要么加载失败退出应用。</p><ol start="2"><li>无法在浏览器端运行</li></ol><p>browserify 作为一个支持 CommonJS Module 的打包器，会将所有的模块打包成一个文件，所有的模块一次性打包完毕。</p><h2 id="appendix"><a href="#appendix" aria-hidden="true" class="header-anchor">#</a> Appendix</h2><h3 id="format-和-loader"><a href="#format-和-loader" aria-hidden="true" class="header-anchor">#</a> Format 和 Loader</h3><p>在理解 CommonJS/AMD/CMD 之前，还需要了解 <strong>module format</strong> 和 <strong>module loader</strong><sup>2</sup>。</p><ul><li>Module format 是一种语法，或者说规范，需要 loader 来 interpret</li><li>Module loader 是用来 interpret format 的工具(一般都是第三方的)</li></ul><h3 id="modularity-is-expensive"><a href="#modularity-is-expensive" aria-hidden="true" class="header-anchor">#</a> Modularity is expensive</h3><p><a href="https://www.youtube.com/watch?v=vypCsVm5z28" target="_blank" rel="noopener noreferrer">A Brief History of Modularity | JSConf EU 2017<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一段很有意思的视频。</p><h3 id="node-js-support-es-module"><a href="#node-js-support-es-module" aria-hidden="true" class="header-anchor">#</a> Node.js support ES Module</h3><p>在 Node.js 的 <a href="https://github.com/nodejs/node/tree/master/lib/internal/modules" target="_blank" rel="noopener noreferrer">Module<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块中，可以看到 <code>v.12</code> 版本开始提供对 ES Module 的支持。</p><p>可以通过 <a href="http://2ality.com/2019/04/nodejs-esm-impl.html" target="_blank" rel="noopener noreferrer">The new ECMAScript module support in Node.js 12<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这篇文章了解一下。</p><h3 id="browserify-支持-umd-打包"><a href="#browserify-支持-umd-打包" aria-hidden="true" class="header-anchor">#</a> browserify 支持 umd 打包</h3><p>使用 <code>--standalone</code> 支持 browserify 将模块打包成 UMD。使用命令：</p><div class="language-bash extra-class"><pre class="language-bash"><code>$ browserify index.js --s R
</code></pre></div><p>可以将模块暴露为一个名为 <code>R</code> 的全局变量。</p><p>参考 <a href="https://stackoverflow.com/questions/23296094/browserify-how-to-call-function-bundled-in-a-file-generated-through-browserify" target="_blank" rel="noopener noreferrer">Browserify - How to call function bundled in a file generated through browserify in browser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="reference"><a href="#reference" aria-hidden="true" class="header-anchor">#</a> Reference</h2><ol><li><p><a href="https://arstechnica.com/information-technology/2009/12/commonjs-effort-sets-javascript-on-path-for-world-domination/" target="_blank" rel="noopener noreferrer">CommonJS effort sets JavaScript on path for world domination<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li><li><p><a href="https://medium.com/@crohacz_86666/basics-of-modular-javascript-2395c82dd93a" target="_blank" rel="noopener noreferrer">Basics of Modular JavaScrip<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ol></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/maoxiaoke/xiaokedada/edit/master/FirstMeet/Webpack-JavaScript-Module-History.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="last-updated"><span class="prefix">上次更新: </span><span class="time">5/10/2019, 12:48:43 PM</span></div></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/xiaokedada/FirstMeet/Webpack-Operating-Principle.html" class="prev">
          从打包结果看 webpack 依赖管理
        </a></span><span class="next"><a href="/xiaokedada/FirstMeet/Type-System-ML.html">
          数理逻辑理论
        </a> →
      </span></p></div></div></div></div>
    <script src="/xiaokedada/assets/js/75.b692daea.js" defer></script><script src="/xiaokedada/assets/js/app.51d0a681.js" defer></script>
  </body>
</html>
