<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript 异步编程 | XIAOKEDADA</title>
    <meta name="description" content="Write something useful and funny">
    <link rel="icon" href="/favicon.png">
    
    <link rel="preload" href="/assets/css/60.styles.cafb42a8.css" as="style"><link rel="preload" href="/assets/js/app.b8b0b773.js" as="script"><link rel="preload" href="/assets/js/32.62fdaf7e.js" as="script"><link rel="prefetch" href="/assets/js/31.a5b853bc.js"><link rel="prefetch" href="/assets/js/1.ce125061.js"><link rel="prefetch" href="/assets/js/2.e75d633a.js"><link rel="prefetch" href="/assets/js/3.bc22e27a.js"><link rel="prefetch" href="/assets/js/4.5bdb0671.js"><link rel="prefetch" href="/assets/js/5.d70f0c38.js"><link rel="prefetch" href="/assets/js/6.e0f7e542.js"><link rel="prefetch" href="/assets/js/7.17b7259f.js"><link rel="prefetch" href="/assets/js/8.aea3df3e.js"><link rel="prefetch" href="/assets/js/9.ea5fd172.js"><link rel="prefetch" href="/assets/js/10.3009a87d.js"><link rel="prefetch" href="/assets/js/11.a5e51afe.js"><link rel="prefetch" href="/assets/js/12.8dd4c51f.js"><link rel="prefetch" href="/assets/js/13.1b379b74.js"><link rel="prefetch" href="/assets/js/14.514bc23f.js"><link rel="prefetch" href="/assets/js/15.3832c45d.js"><link rel="prefetch" href="/assets/js/16.7af6d7af.js"><link rel="prefetch" href="/assets/js/17.3cdb2437.js"><link rel="prefetch" href="/assets/js/18.2430a6ba.js"><link rel="prefetch" href="/assets/js/19.40aad8f5.js"><link rel="prefetch" href="/assets/js/20.6d134223.js"><link rel="prefetch" href="/assets/js/21.179fc23e.js"><link rel="prefetch" href="/assets/js/22.f8f1c7b9.js"><link rel="prefetch" href="/assets/js/23.02274ad4.js"><link rel="prefetch" href="/assets/js/24.bb7ba68a.js"><link rel="prefetch" href="/assets/js/25.3138c472.js"><link rel="prefetch" href="/assets/js/26.0e3d43fa.js"><link rel="prefetch" href="/assets/js/27.fafcdf53.js"><link rel="prefetch" href="/assets/js/28.74630e6f.js"><link rel="prefetch" href="/assets/js/29.769c5352.js"><link rel="prefetch" href="/assets/js/30.85ef2abd.js"><link rel="prefetch" href="/assets/js/0.477da1bb.js"><link rel="prefetch" href="/assets/js/33.fceb35fa.js"><link rel="prefetch" href="/assets/js/34.330b28e6.js"><link rel="prefetch" href="/assets/js/35.6b91f7df.js"><link rel="prefetch" href="/assets/js/36.c963382e.js"><link rel="prefetch" href="/assets/js/37.ee9d9859.js"><link rel="prefetch" href="/assets/js/38.25206d29.js"><link rel="prefetch" href="/assets/js/39.280fd835.js"><link rel="prefetch" href="/assets/js/40.bf9352ae.js"><link rel="prefetch" href="/assets/js/41.44314976.js"><link rel="prefetch" href="/assets/js/42.7bdb22fc.js"><link rel="prefetch" href="/assets/js/43.bd9aadcb.js"><link rel="prefetch" href="/assets/js/44.f6d5ca98.js"><link rel="prefetch" href="/assets/js/45.192bf141.js"><link rel="prefetch" href="/assets/js/46.9ce9488d.js"><link rel="prefetch" href="/assets/js/47.6f5bb519.js"><link rel="prefetch" href="/assets/js/48.78b7e557.js"><link rel="prefetch" href="/assets/js/49.be4aa69e.js"><link rel="prefetch" href="/assets/js/50.cc083fd0.js"><link rel="prefetch" href="/assets/js/51.2d379473.js"><link rel="prefetch" href="/assets/js/52.b4b518df.js"><link rel="prefetch" href="/assets/js/53.4c751806.js"><link rel="prefetch" href="/assets/js/54.24a16a75.js"><link rel="prefetch" href="/assets/js/55.3e91c902.js"><link rel="prefetch" href="/assets/js/56.983e028d.js"><link rel="prefetch" href="/assets/js/57.5933ca10.js"><link rel="prefetch" href="/assets/js/58.072f1379.js"><link rel="prefetch" href="/assets/js/59.eaa05fed.js">
    <link rel="stylesheet" href="/assets/css/60.styles.cafb42a8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      XIAOKEDADA
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/JavaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/FirstMeet/" class="nav-link">FirstMeet系列</a></div><div class="nav-item"><a href="/CSS/" class="nav-link">CSS</a></div><div class="nav-item"><a href="/ReadingNote/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/GatherAll/" class="nav-link">R &amp; T</a></div><a href="https://github.com/maoxiaoke/xiaokedada" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/JavaScript/" class="nav-link router-link-active">JavaScript</a></div><div class="nav-item"><a href="/FirstMeet/" class="nav-link">FirstMeet系列</a></div><div class="nav-item"><a href="/CSS/" class="nav-link">CSS</a></div><div class="nav-item"><a href="/ReadingNote/" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/GatherAll/" class="nav-link">R &amp; T</a></div><a href="https://github.com/maoxiaoke/xiaokedada" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Depth-in-Series</span><!----></p><ul class="sidebar-group-items"><li><a href="/JavaScript/Require-and-Import.html" class="sidebar-link">require 和 import 的难点</a></li><li><a href="/JavaScript/Property-Descriptors.html" class="sidebar-link">JavaScript 对象的 Property descriptors</a></li><li><a href="/JavaScript/Depth-in-ES6.html" class="sidebar-link">深入理解 ES6</a></li><li><a href="/JavaScript/Depth-in-This.html" class="sidebar-link">让人头疼的函数内this的指向</a></li><li><a href="/JavaScript/Depth-in-Closure.html" class="sidebar-link">来一次痛痛快快得闭包挑战</a></li><li><a href="/JavaScript/Async-Programming.html" class="active sidebar-link">JavaScript 异步编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#一个概念" class="sidebar-link">一个概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#event-loop" class="sidebar-link">Event Loop</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#并行" class="sidebar-link">并行</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#运行至完成" class="sidebar-link">运行至完成</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#并发" class="sidebar-link">并发</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#job-queue" class="sidebar-link">Job queue</a></li></ul></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#回调函数" class="sidebar-link">回调函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#callback-hell" class="sidebar-link">callback hell</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#信任问题" class="sidebar-link">信任问题</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#拯救回调" class="sidebar-link">拯救回调</a></li></ul></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#promise" class="sidebar-link">Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#基本概念" class="sidebar-link">基本概念</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#catch" class="sidebar-link">catch()</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#promise-链" class="sidebar-link">promise 链</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#new-promise-构造器" class="sidebar-link">new Promise() 构造器</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#创建-settled-promise" class="sidebar-link">创建 settled promise</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#promise-all-和-promise-race" class="sidebar-link">Promise.all([...]) 和 Promise.race([...])</a></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#promise-不可撤销" class="sidebar-link">Promise 不可撤销</a></li></ul></li><li class="sidebar-sub-header"><a href="/JavaScript/Async-Programming.html#async-和-await" class="sidebar-link">async 和 await</a></li></ul></li><li><a href="/JavaScript/Prototype.html" class="sidebar-link">再谈原型和继承</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Re-learn ES6</span><!----></p><ul class="sidebar-group-items"><li><a href="/JavaScript/ES6-Let-and-Const.html" class="sidebar-link">最佳实践，使用 let/const</a></li><li><a href="/JavaScript/ES6-Symbols.html" class="sidebar-link">万物皆不同 - Symbols</a></li><li><a href="/JavaScript/ES6-Iterator-And-Iterable.html" class="sidebar-link">迭代协议</a></li><li><a href="/JavaScript/ES6-Async.html" class="sidebar-link">异步编程要点</a></li><li><a href="/JavaScript/ES6-Generator.html" class="sidebar-link">Generator</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>基础内容</span><!----></p><ul class="sidebar-group-items"><li><a href="/JavaScript/AJAX.html" class="sidebar-link">AJAX</a></li><li><a href="/JavaScript/Coercion.html" class="sidebar-link">强制类型转换</a></li><li><a href="/JavaScript/Map-and-Reduce.html" class="sidebar-link">JavaScript 的 map/reduce</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>DOM 相关</span><!----></p><ul class="sidebar-group-items"><li><a href="/JavaScript/DOM-Operation.html" class="sidebar-link">原生JavaScript的DOM操作</a></li><li><a href="/JavaScript/DOM-More.html" class="sidebar-link">再来仔细研究DOM</a></li><li><a href="/JavaScript/DOM-History.html" class="sidebar-link">和 URL 相关的 Location 和 History</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Thinking-in-JavaScript</span><!----></p><ul class="sidebar-group-items"><li><a href="/JavaScript/Small-and-Chunk-Code.html" class="sidebar-link">书写有用而优雅的代码</a></li><li><a href="/JavaScript/I-Dont-Know-JavaScript.html" class="sidebar-link">你看到的 JavaScript，并不是真实的</a></li><li><a href="/JavaScript/Refactor-JavaScript.html" class="sidebar-link">有关代码重构和整洁之道</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="javascript-异步编程"><a href="#javascript-异步编程" aria-hidden="true" class="header-anchor">#</a> JavaScript 异步编程</h1><p>异步编程是 JavaScript 中一个非常重要的概念。异步的核心是<strong>现在</strong>和<strong>稍后</strong>。也就是说我们的一个 JavaScript 程序，仅有其中的一个代码块会在 <em>现在</em> 执行，而其他的会 <em>稍后</em> 执行。</p><p>最常见的异步编程就是回调函数了。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//ajax() 是某个包中任意的 Ajax 函数</span>
<span class="token function">ajax</span> <span class="token punctuation">(</span><span class="token string">'http://xiaokedada.com'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token function">callbackFunction</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//应答代码</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在异步调用 ajax 的过程中，<code>callbackFunction()</code> 不会马上执行，而是 稍后 执行。</p><p>最开始，我们要理解一些概念之类的东西。</p><h2 id="一个概念"><a href="#一个概念" aria-hidden="true" class="header-anchor">#</a> 一个概念</h2><h3 id="event-loop"><a href="#event-loop" aria-hidden="true" class="header-anchor">#</a> Event Loop</h3><p>就拿上面这个 ajax 的回调函数来讲，当有数据需要返回时，就会将这个回调函数插入 Event Loop 来安排它的执行。Event Loop 类似于下面的代码:</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//Event Loop 表现得像一个队列</span>

<span class="token keyword">var</span> eventLoop <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> event<span class="token punctuation">;</span>

<span class="token comment">//不断轮询</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 执行一个 tick</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        event <span class="token operator">=</span> eventLoop<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//shift() 模拟队列，取得下一个事件</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行下一个事件</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">reportErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="并行"><a href="#并行" aria-hidden="true" class="header-anchor">#</a> 并行</h3><p>异步和并行是两个不同的概念。并行表示事情可以同时发生，最常见的就是 <em>线程</em> 和 <em>进程</em>。进程和线程独立地、可能同时地执行。</p><h3 id="运行至完成"><a href="#运行至完成" aria-hidden="true" class="header-anchor">#</a> 运行至完成</h3><p>因为 JavaScript 是单线程，所以一个函数(比如: <code>foo(){...}</code>) 内部的代码是 <strong>原子性</strong> 的，意味着 <code>foo()</code> 一旦执行，就必须全部执行，而不会被其他 <em>函数</em> 打断。</p><h3 id="并发"><a href="#并发" aria-hidden="true" class="header-anchor">#</a> 并发</h3><p>并发是当两个或多个 <em>进程</em> 在同一时间段内同时执行。可以认为并发是 <em>进程</em> 级别的并行机制，而不是 <em>线程</em> 级别的并行机制。</p><h3 id="job-queue"><a href="#job-queue" aria-hidden="true" class="header-anchor">#</a> Job queue</h3><p>Job queue 是 Event Loop 之上的一层新概念，可以认为:</p><blockquote><p>Job queue 是挂靠在事件轮询队列的每个 tick 末尾的队列。</p></blockquote><p>有点像 <code>setTimeout(...,0)</code> 的黑科技，以一种更明确的方式告诉你: <strong>稍后，但尽快</strong>。</p><hr><h2 id="回调函数"><a href="#回调函数" aria-hidden="true" class="header-anchor">#</a> 回调函数</h2><p>异步编程就基本的形式，就是 事件模型。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;my-btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
button<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//do something</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>按钮在被点击之后，<code>onclick</code> 内部的代码才会加入 EventLoop 进行执行。</p><p>在比如:</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i love yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>setTimeout()</code> 中的回调函数并不会马上执行，而是会在 100ms 之后被加入到 Event Loop。</p><p>Node.js 诞生之后，回调模式就更广泛了。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">readFile</span> <span class="token punctuation">(</span><span class="token string">&quot;my.txt&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>contents<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i love yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>回调函数是万能的吗？并不是。</p><h3 id="callback-hell"><a href="#callback-hell" aria-hidden="true" class="header-anchor">#</a> callback hell</h3><p><strong>回调地狱</strong> 是回调函数面临的第一个问题。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">'http://xiaodedada.com'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="信任问题"><a href="#信任问题" aria-hidden="true" class="header-anchor">#</a> 信任问题</h3><p>还是我们那个开头的 <code>ajax()</code> 函数。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//A</span>
<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">&quot;http://xiaodedada.com&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//B</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//C</span>
</code></pre></div><p><code>A</code> 和 <code>C</code> 是 现在 发生的，而且在我们的控制之下，但是 <code>B</code> 推迟到 稍后 发生，而且是在 <code>ajax()</code> 的控制之下。如果这个 <code>ajax()</code> 不是你写的，更一般的情况是，它是由第三方提供，这意味着 <strong>控制权被转交给第三方</strong>(控制反转)。你当然希望第三方是可靠的，但是你只是寄希望于自己所无法控制的事物身上而已。</p><h3 id="拯救回调"><a href="#拯救回调" aria-hidden="true" class="header-anchor">#</a> 拯救回调</h3><h4 id="分离回调的设计"><a href="#分离回调的设计" aria-hidden="true" class="header-anchor">#</a> 分离回调的设计</h4><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">success</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//do something</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">failure</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//handler error</span>
<span class="token punctuation">}</span>
<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token string">'http://xiaokedada.com'</span><span class="token punctuation">,</span> success<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>API 设计的时候通过分离回调，例如上面的例子，一个用于成功的通知，一个用于错误的通知。</p><blockquote><p>Promise 就是采用这种 分离回调 的设计。</p></blockquote><h4 id="错误优先风格"><a href="#错误优先风格" aria-hidden="true" class="header-anchor">#</a> 错误优先风格</h4><p>这个 Node.js 惯常使用的一个回调风格。上面的这个例子就是这样的一个风格。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">readFile</span> <span class="token punctuation">(</span><span class="token string">&quot;my.txt&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>contents<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'i love yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>但是，这两种方法都不能真正地拯救回调，并不能真正地解决信任危机。</p><hr><h2 id="promise"><a href="#promise" aria-hidden="true" class="header-anchor">#</a> Promise</h2><h3 id="基本概念"><a href="#基本概念" aria-hidden="true" class="header-anchor">#</a> 基本概念</h3><p>Promises 是针对回调的 <em>控制反转</em> 提供解决方案。这意味着 <em>不是将程序交给第三方，而是希望它返回给我们一个可知道它何时完成的东西，让我们自己决定下一步做什么</em>。也就是，将 <em>控制反转</em> 再反转过来。</p><blockquote><p>Promise 是一个对象，用来传递异步操作的消息。代表了某个未来才会知道结果的事件。 《ES6 标准入门》</p></blockquote><p>Promise 的对象的状态不受外部影响，也称为 promise 的生命周期。</p><ul><li><code>pending</code>: 挂起状态，一开始都处于这个状态。</li><li><code>resolved</code>: 异步操作已完成</li><li><code>rejected</code>: 异步操作失败</li></ul><blockquote><p>pending 状态的 promise 被认为是 <code>unsettled</code>。一旦异步操作完成(不管是成功还是失败)，就被认为是 <code>settled</code>。</p></blockquote><p>Promise 的状态一旦改变就不会再变。也就是说，promise 对象的改变只有两种方式: 从 pending 变成 resolved 和 从 pending 变成 rejected。只要二者之一发生，状态就凝固了，不会再变，任何时候访问都是这个结果。</p><blockquote><p>这和 事件机制 完全不同，一旦错过，再去监听就得不到结果。</p></blockquote><p>所以的 promise 都有一个 <code>then()</code> 方法来指定异步操作完成后的一些操作，接受两个参数，第一个参数是 promise 为 fulfilled 状态下调用的函数，第二个参数是 promise 为 rejected 状态下调用的函数。其中，第二个参数是可选的。</p><p>我们举个 promise 操作 AJAX 的例子来认识一下:</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">getJSON</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span>onreadystatechange <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    client<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">&quot;/posts.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Contents: '</span> <span class="token operator">+</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'出错了'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>例子来源 《ES6 标准入门》</p></blockquote><p>这个例子中，promise 对象通过 Promise 构造函数构建。构造函数接收一个执行函数，该执行函数接收 resolve() 和 reject() 两个参数。resolve() 函数会在执行函数成功运行后表示该 promise 可用，而 reject() 函数代表该执行函数运行失败。然后调用 <code>then()</code> 方法，这个方法会在 promise 状态改变的时候进行 <strong>异步调用</strong>，返回一个新的 Promise 实例。</p><p>比如下面我写的这个例子:</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
yuer
resolved
*/</span>
</code></pre></div><p>由于 <code>then()</code> 是异步调用，所以会先输出 <code>yuer</code>，然后是成功的结果。</p><blockquote><p>以这种方式实现 then() 方法的对象称为 thenable。所有的 promise 都是 thenable，但不是所有的 thenable 都是 promise。</p></blockquote><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> thenable <span class="token operator">=</span> <span class="token punctuation">{</span>
    then<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>thenable<span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'I love '</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>thenable</code> 根本不像 Promise，但会被认为是一个 thenable。通过调用 Promise.resolve() 将这个对象转化为 完成 状态的 promise。</p><h3 id="catch"><a href="#catch" aria-hidden="true" class="header-anchor">#</a> catch()</h3><p>刚才我们讲过 <code>then()</code> 函数，而 <code>catch()</code> 主要是接受一个 rejected 作为回调，等同于 <code>then(null,rejected)</code>。这也就是说，它和 then() 一样，返回一个 Promise 对象。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

promise<span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
yuer
*/</span>
</code></pre></div><h3 id="promise-链"><a href="#promise-链" aria-hidden="true" class="header-anchor">#</a> promise 链</h3><p>刚才有说到，then() 和 catch() 都会返回一个 Promise 实例，就可以使用它们构建 promise 链。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'another resolved'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
yuer
resolved
another resolved
*/</span>
</code></pre></div><h3 id="new-promise-构造器"><a href="#new-promise-构造器" aria-hidden="true" class="header-anchor">#</a> new Promise() 构造器</h3><p>上面我们展示了 new Promise() 的用法，接收一个处理回调函数，这个函数是 <strong>同步或者立即执行</strong> 的。同时，这个函数还接收两个函数回调，<code>resolve()</code> 和 <code>reject()</code>。reject() 用于拒绝这个 promise，但 resolve() 可能完成 promise，也可能需要进一步决议这个 promise。</p><p>如果传给 <code>resolved()</code> 的是一个非 Promise、非 thenable 的立即值，这个 promise 就会这个值立即完成。如果是一个真正的 Promise 或 thenable 值，这个值会被递归展开，而且无论它最终解析结果/状态是什么，都会被 promise 采用。</p><h3 id="创建-settled-promise"><a href="#创建-settled-promise" aria-hidden="true" class="header-anchor">#</a> 创建 settled promise</h3><p>通过 new Promise() 我们创建的是 unsettled 的 promise，也就是说创建完 promise 之后，它的状态是未定的。而创建 已定 的promise，我们是通过 <code>Promise.resolve()</code> 和 <code>Promise.reject()</code> 来创建。</p><ul><li>Promise.resolve() 方法接收单个参数并返回一个 完成状态 的 promise。</li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'I love '</span><span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
I love yuer
*/</span>
</code></pre></div><p>如果传递的是 catch() 处理，则永远不会被调用，因为 promise 不存在 rejected 状态。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 永远不会被调用</span>
promise<span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'I love '</span><span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="promise-all-和-promise-race"><a href="#promise-all-和-promise-race" aria-hidden="true" class="header-anchor">#</a> Promise.all([...]) 和 Promise.race([...])</h3><p>有两个辅助函数 Promise.all([...]) 和 Promise.race([...])。对 Promise.all([...]) 来说，只要传入的所有 promises 都完成，返回 promise 才能完成。如果有任何 promise 被拒绝，返回的 promise 就会被拒绝。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'xiaoke'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完成</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'yuer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完成</span>
<span class="token keyword">var</span> p3 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'Oops'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拒绝</span>

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">,</span>p3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// p3 拒绝，所以 Promise.all() 返回的 promise 被拒绝</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// p1, p2 都完成，返回的 promise 为完成</span>
<span class="token comment">/*
Oops
[ 'xiaoke', 'yuer' ]
*/</span>
</code></pre></div><p>Promise.race([...]) 也好理解，只有第一个决议的 promise 取胜(有可能是 完成，也有可能是 拒绝)。</p><div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p2<span class="token punctuation">,</span>p1<span class="token punctuation">,</span>p3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
yuer
*/</span>
</code></pre></div><blockquote><p>向 Promise.all([...]) 传入空数组会立即完成，但 Promise.race([...]) 会永远挂起，永远不会决议。</p></blockquote><h3 id="promise-不可撤销"><a href="#promise-不可撤销" aria-hidden="true" class="header-anchor">#</a> Promise 不可撤销</h3><p>一旦创建了 Promise 并且注册了一个 完成/拒绝 的回调函数，就没有什么可以从外部取停止这个过程。</p><hr><h2 id="async-和-await"><a href="#async-和-await" aria-hidden="true" class="header-anchor">#</a> async 和 await</h2><p><code>async</code> 和 <code>await</code> 将 Generator 和 Promise 结合起来，以一种更为“优雅”的方式进行异步调用。</p><p><code>async</code> 用在 <code>function</code> 关键字前面(并不一定非在 function 前面，对象的方法前面也是可以的)。表达一个意思：<strong>函数总是返回的一个promise</strong>。如果函数返回一个 <code>&lt;non-promise&gt;</code> 的代码，会被自动包装成一个 resolved promise。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token comment">// 1</span>

<span class="token comment">//显式</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>await</code> 只能用在 <code>async function</code> 内部，使代码停止运行直到 Promise 完成(解析成功或被拒绝)并返回一个结果。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;done!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> promise <span class="token comment">// *</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// &quot;done!&quot;</span>
</code></pre></div><p>代码运行到 * 处暂停，然后等待 Promise 完成。在等待期间，<code>await</code> 不占用 CPU 资源，CPU 可以处理其他事情。</p><p><code>async</code> 和 <code>await</code> 的优雅之处是，以同步的方式书写异步代码。在之前的介绍中，Promise 可以解决回调函数 “回调地狱” 问题，但是同样带来了 “链式地狱” 的问题。</p><p>先写一个 Promise 的例子，使用 Github 的 API。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/maoxiaoke'</span><span class="token punctuation">)</span> <span class="token comment">//获取用户 maoxiaoke 的 github 信息</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>githubUser <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> githubUser<span class="token punctuation">.</span>avatar_url
    img<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'maoxiaoke'</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>现在用 <code>async</code> 和 <code>await</code> 改写。首先用 <code>async</code> 声明一个函数，然后在函数中使用 <code>await</code>。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">showAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/maoxiaoke'</span><span class="token punctuation">)</span> 
    <span class="token keyword">let</span> githubUser <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> githubUser<span class="token punctuation">.</span>avatar_url<span class="token punctuation">;</span>
    img<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;promise-avatar-example&quot;</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>

    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">showAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>处理异常情况</strong>：Promise 使用 reject() 来处理拒绝的情况，<code>async</code> 和 <code>await</code> 采用 <code>try...catch...</code> 来处理。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">showAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span> <span class="token comment">//获取用户 maoxiaoke 的 github 信息</span>
        <span class="token keyword">let</span> githubUser <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>src <span class="token operator">=</span> githubUser<span class="token punctuation">.</span>avatar_url<span class="token punctuation">;</span>
        img<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;promise-avatar-example&quot;</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>

        <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">showAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>也可以这样：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">showAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span> <span class="token comment">//获取用户 maoxiaoke 的 github 信息</span>
    <span class="token keyword">let</span> githubUser <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> githubUser<span class="token punctuation">.</span>avatar_url<span class="token punctuation">;</span>
    img<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;promise-avatar-example&quot;</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>

    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">showAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>alert<span class="token punctuation">)</span>
</code></pre></div><p><code>await</code> 还支持 <code>thenable</code>。所有的 Promise 都是 thenable，但不是所有的 thenable 是 Promise。这样的一些 thenable 对象(一般包含可调用的 then 方法)如果支持可调用的 then 方法，就能使用 <code>await</code>。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Thenable</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">=</span> num<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (*)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Thenable</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/maoxiaoke/xiaokedada/edit/master/JavaScript/Async-Programming.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="last-updated"><span class="prefix">上次更新: </span><span class="time">5/13/2018, 1:00:30 PM</span></div></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/JavaScript/Depth-in-Closure.html" class="prev">
          来一次痛痛快快得闭包挑战
        </a></span><span class="next"><a href="/JavaScript/Prototype.html">
          再谈原型和继承
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/32.62fdaf7e.js" defer></script><script src="/assets/js/app.b8b0b773.js" defer></script>
  </body>
</html>
